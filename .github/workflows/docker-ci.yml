name: CI â€“ Docker validation

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  lint-compose:
    name: Validate docker-compose syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin
      - name: Check docker-compose.yml syntax
        run: docker compose config

  build-and-test:
    name: Build images & smoke-test
    needs: lint-compose
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin

      - name: Build all images
        run: docker compose build --parallel

      - name: Start services
        run: docker compose up -d

      - name: Wait for Dash web to be healthy
        run: |
          for i in {1..10}; do
            curl --fail http://localhost:8050/ && break || sleep 5
          done

      - name: Smoke-test model services
        run: |
          curl --fail http://localhost:5001/health || (echo "Model A down" && exit 1)
          curl --fail http://localhost:5002/health || (echo "Model B down" && exit 1)

      - name: Teardown
        run: docker compose down
